// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id              String   @id @default(cuid())
  uid             Int      @unique // 数字UID，如100001
  email           String   @unique
  password        String
  nickname        String
  avatar          String?
  phone           String?  @unique
  phoneVerified   Boolean  @default(false)
  province        String?
  city            String?
  district        String?
  bio             String?  // 个人简介
  role            String   @default("USER") // USER | ADMIN
  status          String   @default("ACTIVE") // ACTIVE | BANNED

  // 统计数据（冗余字段，提升查询性能）
  totalAgents     Int      @default(0) // 拥有的智能体总数
  totalChats      Int      @default(0) // 对话总次数

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 关联
  orders          Order[]
  userAgents      UserAgent[]
  activationCodes ActivationCode[]
  chatHistories   ChatHistory[]
  exchanges       Exchange[]                      @relation("UserExchanges") // 发布的交换
  proposals       ExchangeProposal[]              @relation("ExchangeProposals") // 发起的交换请求
  addresses       Address[]

  @@index([email])
  @@index([uid])
  @@map("users")
}

// 系列表（盲盒系列）
model Series {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  coverImage  String?
  price       Float
  stock       Int      @default(0) // 库存数量
  purchaseUrl String?  // 购买链接（淘宝等外部平台）
  order       Int      @default(0) // 排序字段
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联
  agents Agent[]
  orders Order[]

  @@index([slug])
  @@index([isActive])
  @@index([order])
  @@map("series")
}

// 智能体角色表
model Agent {
  id             String    @id @default(cuid())
  seriesId       String?
  name           String
  slug           String    @unique

  // AI Provider配置
  provider       String    @default("COZE") // COZE | OPENAI
  providerConfig String    @default("{}") // JSON字符串，存储不同provider的配置

  // 兼容性字段（废弃但保留）
  botId          String?   // 废弃，改用providerConfig

  rarity         String // STANDARD | HIDDEN
  avatar         String
  description    String
  abilities      String // JSON 字符串存储能力列表
  price          Float
  stock          Int       @default(0)
  isActive       Boolean   @default(true)
  systemPrompt   String?
  deletedAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // 关联
  series          Series?          @relation(fields: [seriesId], references: [id])
  orders          Order[]
  userAgents      UserAgent[]
  activationCodes ActivationCode[]
  chatHistories   ChatHistory[]
  wantedByExchanges Exchange[]     @relation("ExchangeWantedAgent") // 被想要的交换

  @@index([slug])
  @@index([seriesId])
  @@index([deletedAt])
  @@index([isActive])
  @@index([provider])
  @@map("agents")
}

// 订单表
model Order {
  id               String   @id @default(cuid())
  userId           String
  seriesId         String? // 购买的是系列盲盒
  agentId          String? // 兼容旧数据：单个智能体购买
  activationCodeId String?  @unique
  status           String   @default("PENDING") // PENDING | PAID | SHIPPED | COMPLETED | REFUNDED
  amount           Float
  paymentMethod    String?
  transactionId    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // 关联
  user           User            @relation(fields: [userId], references: [id])
  series         Series?         @relation(fields: [seriesId], references: [id])
  agent          Agent?          @relation(fields: [agentId], references: [id])
  activationCode ActivationCode? @relation(fields: [activationCodeId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([seriesId])
  @@index([agentId])
  @@map("orders")
}

// 激活码表
model ActivationCode {
  id          String    @id @default(cuid())
  code        String    @unique
  agentId     String
  status      String    @default("UNUSED") // UNUSED | ACTIVATED | VOID
  userId      String?
  activatedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 关联
  agent          Agent              @relation(fields: [agentId], references: [id])
  user           User?              @relation(fields: [userId], references: [id])
  order          Order?             @relation
  userAgent      UserAgent?
  exchange       Exchange?          @relation("ExchangeActivationCode")
  exchangeProposals ExchangeProposal[] @relation("ExchangeProposalCodes") // 交换请求中使用的激活码

  @@index([code])
  @@index([status])
  @@index([userId])
  @@map("activation_codes")
}

// 用户拥有的智能体表
model UserAgent {
  id               String    @id @default(cuid())
  userId           String
  agentId          String
  activationCodeId String    @unique
  activatedAt      DateTime  @default(now())
  lastChatAt       DateTime?

  // 关联
  user           User           @relation(fields: [userId], references: [id])
  agent          Agent          @relation(fields: [agentId], references: [id])
  activationCode ActivationCode @relation(fields: [activationCodeId], references: [id])
  chatHistories  ChatHistory[]

  @@unique([userId, agentId])
  @@index([userId])
  @@index([agentId])
  @@map("user_agents")
}

// 对话历史表
model ChatHistory {
  id             String   @id @default(cuid())
  userId         String
  agentId        String
  userAgentId    String
  role           String
  content        String
  images         String?  // 图片附件（JSON字符串，存储ImageAttachment数组）
  conversationId String?
  createdAt      DateTime @default(now())

  // 关联
  user      User      @relation(fields: [userId], references: [id])
  agent     Agent     @relation(fields: [agentId], references: [id])
  userAgent UserAgent @relation(fields: [userAgentId], references: [id])

  @@index([userId])
  @@index([agentId])
  @@index([conversationId])
  @@map("chat_histories")
}

// 交换发布表（用户发布的交换信息）
model Exchange {
  id               String    @id @default(cuid())
  userId           String
  activationCodeId String    @unique
  wantedAgentId    String    // 用户想要的智能体
  status           String    @default("PENDING") // PENDING | TRADING | COMPLETED | CANCELLED
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // 关联
  user           User           @relation("UserExchanges", fields: [userId], references: [id])
  activationCode ActivationCode @relation("ExchangeActivationCode", fields: [activationCodeId], references: [id])
  wantedAgent    Agent          @relation("ExchangeWantedAgent", fields: [wantedAgentId], references: [id])
  proposals      ExchangeProposal[]

  @@index([status])
  @@index([userId])
  @@index([wantedAgentId])
  @@map("exchanges")
}

// 交换请求表（用户发起的交换请求）
model ExchangeProposal {
  id              String   @id @default(cuid())
  exchangeId      String
  proposerUserId  String   // 发起请求的用户
  proposerCodeId  String   // 发起者提供的激活码
  status          String   @default("PENDING") // PENDING | ACCEPTED | REJECTED | CANCELLED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 关联
  exchange       Exchange       @relation(fields: [exchangeId], references: [id])
  proposer       User           @relation("ExchangeProposals", fields: [proposerUserId], references: [id])
  proposerCode   ActivationCode @relation("ExchangeProposalCodes", fields: [proposerCodeId], references: [id])

  @@index([exchangeId])
  @@index([status])
  @@index([proposerUserId])
  @@map("exchange_proposals")
}

// 收货地址表
model Address {
  id          String   @id @default(cuid())
  userId      String
  name        String   // 收货人姓名
  phone       String   // 收货人手机号
  province    String   // 省
  city        String   // 市
  district    String   // 区
  detail      String   // 详细地址
  isDefault   Boolean  @default(false) // 是否默认地址
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("addresses")
}
